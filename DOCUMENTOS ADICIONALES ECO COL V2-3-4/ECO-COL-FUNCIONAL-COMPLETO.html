<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ECO-COL V1 - Sistema Completo</title>
    <script src="https://unpkg.com/dicom-parser@1.8.11/dist/dicomParser.min.js"></script>
    <style>
        :root{--primary:#00695c;--accent:#00bfa5;--bg:#121212;--panel:#1e1e1e;--border:#333}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#fff;height:100vh;overflow:hidden}
        .header{background:linear-gradient(135deg,#004d40,var(--primary));padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--accent)}
        .header h1{font-size:1.5rem}
        .badge{background:var(--accent);color:#000;padding:0.25rem 0.75rem;border-radius:20px;font-size:0.75rem;font-weight:700}
        .main{display:grid;grid-template-columns:320px 1fr 360px;height:calc(100vh - 73px)}
        .panel{background:var(--panel);overflow-y:auto}
        .left{border-right:1px solid var(--border)}
        .right{border-left:1px solid var(--border);padding:1.5rem}
        .center{background:#000;display:flex;flex-direction:column}
        .toolbar{background:#1a1a1a;padding:0.75rem;display:flex;gap:0.5rem;border-bottom:1px solid var(--border);flex-wrap:wrap}
        .btn{background:#2a2a2a;border:1px solid var(--border);color:#fff;padding:0.6rem 1rem;border-radius:6px;cursor:pointer;font-size:0.85rem;transition:all 0.3s}
        .btn:hover,.btn.active{background:var(--primary)}
        .viewer{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
        #canvas{max-width:100%;max-height:100%;border:2px solid var(--accent);box-shadow:0 8px 32px rgba(0,191,165,0.3);image-rendering:pixelated}
        .overlay{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.85);padding:0.75rem;border-radius:6px;border:1px solid var(--accent);font-family:monospace;font-size:0.75rem;line-height:1.6;pointer-events:none;max-width:300px}
        .overlay-label{color:var(--accent);font-weight:700;margin-right:0.5rem}
        .cine{position:absolute;bottom:15px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.95);padding:0.75rem 1.5rem;border-radius:40px;display:flex;gap:1rem;border:2px solid var(--accent)}
        .cine-btn{background:var(--primary);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1rem;transition:all 0.3s}
        .cine-btn:hover{background:var(--accent);transform:scale(1.1)}
        .cine-btn:active{transform:scale(0.95)}
        .frame-info{color:var(--accent);font-weight:700;font-size:0.85rem;display:flex;align-items:center;min-width:90px;justify-content:center}
        .study-card{background:#252525;border:1px solid var(--border);border-radius:6px;padding:0.75rem;margin:0.4rem;cursor:pointer;transition:all 0.3s}
        .study-card:hover{background:linear-gradient(135deg,#1a4a44,#256d63);border-color:var(--accent);transform:translateX(3px)}
        .study-card.active{background:linear-gradient(135deg,#1a4a44,#256d63);border-color:var(--accent)}
        .control-section{margin-bottom:1.5rem}
        .control-section h3{font-size:0.85rem;color:var(--accent);margin-bottom:0.75rem;padding-bottom:0.5rem;border-bottom:2px solid var(--primary);text-transform:uppercase;letter-spacing:0.5px}
        .control-label{display:flex;justify-content:space-between;margin-bottom:0.4rem;font-size:0.8rem}
        .control-value{color:var(--accent);font-weight:700}
        input[type="range"]{width:100%;height:5px;background:var(--border);-webkit-appearance:none;border-radius:3px;margin:0.5rem 0}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px rgba(0,191,165,0.5)}
        .stats{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
        .stat{background:#252525;padding:0.75rem;border-radius:6px;text-align:center;border:1px solid var(--border)}
        .stat-value{font-size:1.3rem;font-weight:700;color:var(--accent)}
        .stat-label{font-size:0.7rem;color:#b0b0b0;text-transform:uppercase;margin-top:0.25rem}
        .pulse{width:8px;height:8px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(1.2)}}
        .search-box{width:100%;padding:0.65rem;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:#fff;font-size:0.85rem;transition:all 0.3s}
        .search-box:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,191,165,0.1)}
        .action-btn{padding:0.65rem;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:0.8rem;transition:all 0.3s;text-transform:uppercase;letter-spacing:0.3px}
        .action-btn:active{transform:scale(0.95)}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--accent);transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,191,165,0.3)}
        .btn-secondary{background:#2a2a2a;color:#fff;border:1px solid var(--border)}
        .btn-secondary:hover{background:#3a3a3a;border-color:var(--accent)}
        .drop-zone{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:3px dashed var(--accent);border-radius:10px;padding:2.5rem 2rem;text-align:center;color:var(--accent);font-size:1.1rem;pointer-events:none;opacity:0;transition:opacity 0.3s;background:rgba(0,0,0,0.8)}
        .drop-zone.active{opacity:1}
        .message{position:fixed;top:85px;right:15px;padding:0.85rem 1.25rem;border-radius:6px;font-weight:600;font-size:0.85rem;z-index:9999;animation:slideIn 0.3s;box-shadow:0 6px 20px rgba(0,0,0,0.4)}
        .message.success{background:#388e3c;border:2px solid #66bb6a}
        .message.error{background:#d32f2f;border:2px solid #ef5350}
        .message.info{background:#1976d2;border:2px solid #42a5f5}
        @keyframes slideIn{from{transform:translateX(350px);opacity:0}to{transform:translateX(0);opacity:1}}
        .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--accent);font-size:1.2rem;pointer-events:none;z-index:100}
        @keyframes spin{to{transform:rotate(360deg)}}
        .spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
        .upload-btn{width:100%;margin-top:0.65rem;padding:0.7rem;background:var(--primary);color:#fff;border:none;border-radius:5px;cursor:pointer;font-weight:600;text-transform:uppercase;font-size:0.8rem;transition:all 0.3s}
        .upload-btn:hover{background:var(--accent)}
        .upload-btn:active{transform:scale(0.98)}
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex;align-items:center;gap:1rem">
            <h1>üè• ECO-COL V1</h1>
            <span class="badge">SISTEMA PROFESIONAL</span>
        </div>
        <div style="display:flex;gap:1.5rem;align-items:center;font-size:0.85rem">
            <div style="display:flex;align-items:center;gap:0.4rem"><span class="pulse"></span>Sistema Activo</div>
            <div>üîí 100% Local</div>
            <div id="clock" style="font-family:monospace">--:--:--</div>
        </div>
    </div>
    <div class="main">
        <div class="panel left">
            <div style="padding:1rem;background:#252525;border-bottom:2px solid var(--primary)">
                <h2 style="font-size:0.9rem;color:var(--accent);margin-bottom:0.65rem;text-transform:uppercase;letter-spacing:0.5px">üìã ESTUDIOS DICOM</h2>
                <input type="text" class="search-box" placeholder="üîç Buscar..." oninput="searchStudies(this.value)">
                <button class="upload-btn" onclick="handleUploadClick()">üì§ CARGAR DICOM</button>
            </div>
            <div style="padding:0.4rem" id="studies-container">
                <div style="text-align:center;padding:2rem;color:#666;font-size:0.85rem">
                    <div style="font-size:3rem;margin-bottom:1rem">üìÅ</div>
                    <div>No hay estudios cargados</div>
                    <div style="margin-top:0.5rem;font-size:0.75rem">Arrastra archivos DICOM o haz clic en "CARGAR DICOM"</div>
                </div>
            </div>
        </div>
        <div class="center" id="drop-area">
            <div class="toolbar">
                <button class="btn active" onclick="handleToolClick('pan')">üîç Pan</button>
                <button class="btn" onclick="handleToolClick('window')">üéöÔ∏è Ventana</button>
                <button class="btn" onclick="handleInvertClick()">üîÑ Invertir</button>
                <button class="btn" onclick="handleResetClick()">‚Üª Reset</button>
                <button class="btn" onclick="handleAutoAdjustClick()">‚ú® Auto</button>
            </div>
            <div class="viewer">
                <canvas id="canvas" width="512" height="512"></canvas>
                <div class="overlay">
                    <div><span class="overlay-label">PAC:</span><span id="patient">--</span></div>
                    <div><span class="overlay-label">ID:</span><span id="patid">--</span></div>
                    <div><span class="overlay-label">FECHA:</span><span id="date">--</span></div>
                    <div><span class="overlay-label">MOD:</span><span id="modality">--</span></div>
                    <div><span class="overlay-label">DIM:</span><span id="dims">--</span></div>
                    <div><span class="overlay-label">BITS:</span><span id="bits">--</span></div>
                </div>
                <div class="cine">
                    <button class="cine-btn" id="play-btn" onclick="handlePlayPauseClick()">‚ñ∂Ô∏è</button>
                    <button class="cine-btn" onclick="handlePrevClick()">‚èÆ</button>
                    <span class="frame-info" id="frame">1/1</span>
                    <button class="cine-btn" onclick="handleNextClick()">‚è≠</button>
                    <button class="cine-btn" onclick="handleStopClick()">‚èπ</button>
                </div>
                <div class="drop-zone" id="drop-zone">üìÅ Arrastra archivos DICOM aqu√≠<br><small style="opacity:0.7;font-size:0.8rem">Soporta multi-frame, 8/16-bit, color</small></div>
                <div class="loading" id="loading" style="display:none"><div class="spinner"></div>Procesando DICOM...</div>
            </div>
        </div>
        <div class="panel right">
            <div class="control-section">
                <h3>üéöÔ∏è VENTANA / NIVEL</h3>
                <div style="margin-bottom:1rem">
                    <div class="control-label"><span>Centro</span><span class="control-value" id="cv">128</span></div>
                    <input type="range" id="center" min="0" max="255" value="128" oninput="handleWindowChange()">
                </div>
                <div>
                    <div class="control-label"><span>Ancho</span><span class="control-value" id="wv">255</span></div>
                    <input type="range" id="width" min="1" max="255" value="255" oninput="handleWindowChange()">
                </div>
            </div>
            <div class="control-section">
                <h3>üé¨ CONTROL CINE</h3>
                <div class="control-label"><span>FPS</span><span class="control-value" id="fv">10</span></div>
                <input type="range" id="fps" min="1" max="60" value="10" oninput="handleFPSChange()">
            </div>
            <div class="control-section">
                <h3>üîß HERRAMIENTAS</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem">
                    <button class="action-btn btn-primary" onclick="handleExportClick()">üíæ Export</button>
                    <button class="action-btn btn-primary" onclick="handleExportAllClick()">üì¶ Todo</button>
                    <button class="action-btn btn-secondary" onclick="handleUploadClick()">üì§ Subir</button>
                    <button class="action-btn btn-secondary" onclick="handleInfoClick()">‚ÑπÔ∏è Info</button>
                </div>
            </div>
            <div class="control-section">
                <h3>üìä ESTAD√çSTICAS</h3>
                <div class="stats">
                    <div class="stat"><div class="stat-value" id="st-studies">0</div><div class="stat-label">Estudios</div></div>
                    <div class="stat"><div class="stat-value" id="st-frames">0</div><div class="stat-label">Frames</div></div>
                    <div class="stat"><div class="stat-value" id="sf">10</div><div class="stat-label">FPS</div></div>
                    <div class="stat"><div class="stat-value" id="st-memory">0</div><div class="stat-label">MB</div></div>
                </div>
            </div>
        </div>
    </div>
    
    <input type="file" id="file-input" accept=".dcm,.dicom,image/*" multiple style="display:none">
    
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let canvas, ctx, currentFrame = 0, totalFrames = 1;
        let playing = false, interval = null, fps = 10;
        let currentTool = 'pan', loadedStudies = [], currentStudyIndex = -1;
        let allFrames = [], inverted = false, currentStudy = null;
        
        // ==================== INICIALIZACI√ìN ====================
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üè• Inicializando ECO-COL V1...');
            
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            // Configurar input de archivo
            const fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', handleFileInputChange);
            
            // Configurar drag & drop
            setupDragDrop();
            
            // Reloj
            setInterval(updateClock, 1000);
            updateClock();
            
            console.log('‚úÖ ECO-COL V1 Inicializado');
            showMessage('‚úÖ Sistema listo para usar', 'success');
        });
        
        // ==================== MANEJO DE BOTONES ====================
        function handleUploadClick() {
            console.log('üì§ Click en cargar archivo');
            const fileInput = document.getElementById('file-input');
            fileInput.click();
        }
        
        function handleFileInputChange(event) {
            console.log('üìÅ Archivos seleccionados:', event.target.files.length);
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                loadFiles(files);
            }
            // Reset input
            event.target.value = '';
        }
        
        function handleToolClick(tool) {
            console.log('üîß Herramienta seleccionada:', tool);
            currentTool = tool;
            document.querySelectorAll('.toolbar .btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            showMessage(\`Herramienta: \${tool}\`, 'info');
        }
        
        function handlePlayPauseClick() {
            console.log('‚ñ∂Ô∏è Play/Pause');
            if (totalFrames <= 1) {
                showMessage('‚ö†Ô∏è Solo hay 1 frame', 'info');
                return;
            }
            playing = !playing;
            const btn = document.getElementById('play-btn');
            if (playing) {
                interval = setInterval(() => {
                    currentFrame = (currentFrame + 1) % totalFrames;
                    render();
                }, 1000 / fps);
                btn.textContent = '‚è∏';
            } else {
                clearInterval(interval);
                btn.textContent = '‚ñ∂Ô∏è';
            }
        }
        
        function handleNextClick() {
            console.log('‚è≠ Next frame');
            if (allFrames.length > 0) {
                currentFrame = (currentFrame + 1) % totalFrames;
                render();
            }
        }
        
        function handlePrevClick() {
            console.log('‚èÆ Previous frame');
            if (allFrames.length > 0) {
                currentFrame = (currentFrame - 1 + totalFrames) % totalFrames;
                render();
            }
        }
        
        function handleStopClick() {
            console.log('‚èπ Stop');
            playing = false;
            clearInterval(interval);
            currentFrame = 0;
            render();
            document.getElementById('play-btn').textContent = '‚ñ∂Ô∏è';
        }
        
        function handleWindowChange() {
            document.getElementById('cv').textContent = document.getElementById('center').value;
            document.getElementById('wv').textContent = document.getElementById('width').value;
            render();
        }
        
        function handleFPSChange() {
            fps = parseInt(document.getElementById('fps').value);
            document.getElementById('fv').textContent = fps;
            document.getElementById('sf').textContent = fps;
            if (playing) {
                clearInterval(interval);
                interval = setInterval(() => {
                    currentFrame = (currentFrame + 1) % totalFrames;
                    render();
                }, 1000 / fps);
            }
        }
        
        function handleResetClick() {
            console.log('‚Üª Reset view');
            document.getElementById('center').value = 128;
            document.getElementById('width').value = 255;
            inverted = false;
            handleWindowChange();
            showMessage('‚úÖ Vista restablecida', 'info');
        }
        
        function handleInvertClick() {
            console.log('üîÑ Invertir colores');
            inverted = !inverted;
            render();
            showMessage(inverted ? 'üîÑ Colores invertidos' : 'üîÑ Colores normales', 'info');
        }
        
        function handleAutoAdjustClick() {
            console.log('‚ú® Auto ajuste');
            if (!allFrames.length) {
                showMessage('‚ö†Ô∏è No hay imagen cargada', 'error');
                return;
            }
            const data = allFrames[currentFrame].data;
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                const val = data[i];
                if (val < min) min = val;
                if (val > max) max = val;
            }
            const center = Math.floor((min + max) / 2);
            const width = Math.floor((max - min) * 1.2);
            document.getElementById('center').value = center;
            document.getElementById('width').value = width;
            handleWindowChange();
            showMessage('‚ú® Auto-ajuste aplicado', 'success');
        }
        
        function handleExportClick() {
            console.log('üíæ Exportar frame');
            if (!allFrames.length) {
                showMessage('‚ö†Ô∏è No hay imagen para exportar', 'error');
                return;
            }
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.download = \`\${currentStudy?.filename || 'eco-col'}-f\${currentFrame + 1}.png\`;
            a.href = url;
            a.click();
            showMessage('üíæ Frame exportado', 'success');
        }
        
        function handleExportAllClick() {
            console.log('üì¶ Exportar todos');
            if (!allFrames.length) {
                showMessage('‚ö†Ô∏è No hay im√°genes para exportar', 'error');
                return;
            }
            if (totalFrames === 1) return handleExportClick();
            
            allFrames.forEach((frame, i) => {
                ctx.putImageData(frame, 0, 0);
                const url = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.download = \`\${currentStudy?.filename || 'eco-col'}-f\${i + 1}.png\`;
                a.href = url;
                a.click();
            });
            render();
            showMessage(\`üì¶ \${totalFrames} frames exportados\`, 'success');
        }
        
        function handleInfoClick() {
            console.log('‚ÑπÔ∏è Mostrar info');
            if (!currentStudy) {
                showMessage('‚ö†Ô∏è No hay estudio cargado', 'error');
                return;
            }
            alert(\`üìä INFORMACI√ìN DETALLADA

Archivo: \${currentStudy.filename}
Paciente: \${currentStudy.patient}
ID: \${currentStudy.patientId}
Fecha: \${currentStudy.date}
Modalidad: \${currentStudy.modality}
Dimensiones: \${currentStudy.width}x\${currentStudy.height}
Profundidad: \${currentStudy.bits} bits
Total Frames: \${currentStudy.frames || 1}
Memoria: \${Math.round(allFrames.reduce((s, f) => s + f.data.length, 0) / 1024 / 1024)} MB\`);
        }
        
        // ==================== CARGA DE ARCHIVOS ====================
        async function loadFiles(files) {
            console.log('üìÅ Cargando', files.length, 'archivos');
            for (const file of files) {
                console.log('  -', file.name, file.size, 'bytes');
                if (file.name.match(/\.(dcm|dicom)$/i)) {
                    const buffer = await file.arrayBuffer();
                    loadDICOMFile(buffer, file.name);
                } else if (file.type.startsWith('image/')) {
                    const url = await readAsDataURL(file);
                    loadImageFile(url, file.name);
                }
            }
        }
        
        function readAsDataURL(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }
        
        function loadImageFile(dataUrl, filename) {
            const img = new Image();
            img.onload = () => {
                canvas.width = Math.min(img.width, 1024);
                canvas.height = Math.min(img.height, 1024);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                allFrames = [ctx.getImageData(0, 0, canvas.width, canvas.height)];
                currentFrame = 0;
                totalFrames = 1;
                addStudy({
                    type: 'image',
                    filename,
                    patient: 'IMAGEN',
                    patientId: 'IMG-' + Date.now(),
                    date: new Date().toLocaleDateString('es-CO'),
                    modality: 'IMG',
                    bits: 8,
                    width: canvas.width,
                    height: canvas.height,
                    frames: 1
                });
                showMessage(\`‚úÖ Imagen: \${filename}\`, 'success');
            };
            img.src = dataUrl;
        }
        
        function loadDICOMFile(arrayBuffer, filename) {
            document.getElementById('loading').style.display = 'block';
            try {
                const uint8 = new Uint8Array(arrayBuffer);
                const dataSet = dicomParser.parseDicom(uint8);
                
                const patientName = (dataSet.string('x00100010') || 'DESCONOCIDO').replace(/\^/g, ' ');
                const patientID = dataSet.string('x00100020') || 'ID-' + Date.now();
                let studyDate = dataSet.string('x00080020') || '';
                if (studyDate.length === 8) studyDate = \`\${studyDate.slice(6, 8)}/\${studyDate.slice(4, 6)}/\${studyDate.slice(0, 4)}\`;
                const modality = dataSet.string('x00080060') || 'US';
                const rows = dataSet.uint16('x00280010');
                const cols = dataSet.uint16('x00280011');
                const bitsAllocated = dataSet.uint16('x00280100') || 8;
                const samplesPerPixel = dataSet.uint16('x00280002') || 1;
                const photometric = dataSet.string('x00280004') || 'MONOCHROME2';
                const numFrames = parseInt(dataSet.string('x00280008') || '1');
                const pixelDataElement = dataSet.elements.x7fe00010;
                
                if (!pixelDataElement) throw new Error('Sin pixel data');
                
                const pixelData = new Uint8Array(uint8.buffer, pixelDataElement.dataOffset, pixelDataElement.length);
                
                console.log(\`üìä \${filename}: \${cols}x\${rows}x\${numFrames}, \${bitsAllocated}bit, \${photometric}\`);
                
                canvas.width = cols;
                canvas.height = rows;
                allFrames = [];
                
                const pixelsPerFrame = rows * cols;
                const isColor = samplesPerPixel === 3;
                const is16bit = bitsAllocated === 16;
                const invert = photometric === 'MONOCHROME1';
                
                for (let f = 0; f < numFrames; f++) {
                    const imgData = ctx.createImageData(cols, rows);
                    const data = imgData.data;
                    
                    if (isColor) {
                        const offset = f * pixelsPerFrame * 3;
                        for (let i = 0; i < pixelsPerFrame; i++) {
                            const idx = offset + i * 3;
                            data[i * 4] = pixelData[idx];
                            data[i * 4 + 1] = pixelData[idx + 1];
                            data[i * 4 + 2] = pixelData[idx + 2];
                            data[i * 4 + 3] = 255;
                        }
                    } else if (is16bit) {
                        const offset = f * pixelsPerFrame * 2;
                        for (let i = 0; i < pixelsPerFrame; i++) {
                            const idx = offset + i * 2;
                            const val16 = (pixelData[idx + 1] << 8) | pixelData[idx];
                            let val8 = Math.floor((val16 / 65535) * 255);
                            if (invert) val8 = 255 - val8;
                            data[i * 4] = data[i * 4 + 1] = data[i * 4 + 2] = val8;
                            data[i * 4 + 3] = 255;
                        }
                    } else {
                        const offset = f * pixelsPerFrame;
                        for (let i = 0; i < pixelsPerFrame; i++) {
                            let val = pixelData[offset + i];
                            if (invert) val = 255 - val;
                            data[i * 4] = data[i * 4 + 1] = data[i * 4 + 2] = val;
                            data[i * 4 + 3] = 255;
                        }
                    }
                    
                    allFrames.push(imgData);
                }
                
                currentFrame = 0;
                totalFrames = numFrames;
                ctx.putImageData(allFrames[0], 0, 0);
                
                addStudy({
                    type: 'dicom',
                    filename,
                    patient: patientName,
                    patientId: patientID,
                    date: studyDate,
                    modality,
                    bits: bitsAllocated,
                    width: cols,
                    height: rows,
                    frames: numFrames
                });
                
                if (numFrames > 1) {
                    showMessage(\`‚úÖ \${filename}: \${numFrames} frames\`, 'success');
                    setTimeout(() => handlePlayPauseClick(), 500);
                } else {
                    showMessage(\`‚úÖ \${filename} cargado\`, 'success');
                }
                
                handleAutoAdjustClick();
            } catch (e) {
                console.error('‚ùå', e);
                showMessage(\`‚ùå Error: \${e.message}\`, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ==================== DRAG & DROP ====================
        function setupDragDrop() {
            const dropArea = document.getElementById('drop-area');
            const dropZone = document.getElementById('drop-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                dropArea.addEventListener(e, ev => {
                    ev.preventDefault();
                    ev.stopPropagation();
                }, false);
            });
            
            ['dragenter', 'dragover'].forEach(e => {
                dropArea.addEventListener(e, () => dropZone.classList.add('active'), false);
            });
            
            ['dragleave', 'drop'].forEach(e => {
                dropArea.addEventListener(e, () => dropZone.classList.remove('active'), false);
            });
            
            dropArea.addEventListener('drop', e => {
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    loadFiles(files);
                }
            }, false);
        }
        
        // ==================== GESTI√ìN DE ESTUDIOS ====================
        function addStudy(study) {
            currentStudy = study;
            loadedStudies.push(study);
            currentStudyIndex = loadedStudies.length - 1;
            updateStudiesList();
            updateOverlay(study);
            updateStats();
        }
        
        function updateStudiesList() {
            const container = document.getElementById('studies-container');
            if (loadedStudies.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:#666;font-size:0.85rem"><div style="font-size:3rem;margin-bottom:1rem">üìÅ</div><div>No hay estudios cargados</div><div style="margin-top:0.5rem;font-size:0.75rem">Arrastra archivos DICOM o haz clic en "CARGAR DICOM"</div></div>';
                return;
            }
            
            container.innerHTML = '';
            loadedStudies.forEach((s, i) => {
                const card = document.createElement('div');
                card.className = 'study-card' + (i === currentStudyIndex ? ' active' : '');
                card.setAttribute('data-index', i);
                card.onclick = () => loadStudy(i);
                card.innerHTML = \`<div style="display:flex;justify-content:space-between;margin-bottom:0.4rem"><span style="font-weight:700;color:var(--accent);font-size:0.85rem">\${s.filename || '#' + (i + 1)}</span><span style="background:var(--primary);padding:0.15rem 0.4rem;border-radius:3px;font-size:0.65rem;font-weight:700">\${s.modality}</span></div><div style="font-size:0.75rem;color:#b0b0b0;line-height:1.5"><div><strong style="color:#fff">Pac:</strong> \${s.patient.slice(0, 20)}</div><div><strong style="color:#fff">ID:</strong> \${s.patientId.slice(0, 15)}</div><div><strong style="color:#fff">Frames:</strong> \${s.frames || 1}</div></div>\`;
                container.appendChild(card);
            });
        }
        
        function loadStudy(index) {
            if (index < 0 || index >= loadedStudies.length) return;
            currentStudyIndex = index;
            currentStudy = loadedStudies[index];
            currentFrame = 0;
            render();
            updateOverlay(currentStudy);
            document.querySelectorAll('.study-card').forEach(c => c.classList.remove('active'));
            document.querySelector(\`[data-index="\${index}"]\`).classList.add('active');
        }
        
        function updateOverlay(s) {
            document.getElementById('patient').textContent = s.patient.slice(0, 25);
            document.getElementById('patid').textContent = s.patientId.slice(0, 20);
            document.getElementById('date').textContent = s.date;
            document.getElementById('modality').textContent = s.modality;
            document.getElementById('bits').textContent = s.bits + 'b';
            document.getElementById('dims').textContent = \`\${s.width}x\${s.height}\`;
        }
        
        function updateStats() {
            document.getElementById('st-studies').textContent = loadedStudies.length;
            document.getElementById('st-frames').textContent = totalFrames;
            const mb = Math.round(allFrames.reduce((s, f) => s + f.data.length, 0) / 1024 / 1024);
            document.getElementById('st-memory').textContent = mb;
        }
        
        function searchStudies(query) {
            document.querySelectorAll('.study-card').forEach(card => {
                card.style.display = card.textContent.toLowerCase().includes(query.toLowerCase()) ? 'block' : 'none';
            });
        }
        
        // ==================== RENDERIZADO ====================
        function render() {
            if (!allFrames.length) return;
            const imgData = allFrames[currentFrame];
            const tempData = ctx.createImageData(canvas.width, canvas.height);
            const src = imgData.data, dst = tempData.data;
            const center = parseFloat(document.getElementById('center').value);
            const width = parseFloat(document.getElementById('width').value);
            const min = center - width / 2, max = center + width / 2;
            
            for (let i = 0; i < src.length; i += 4) {
                let val = src[i];
                if (inverted) val = 255 - val;
                let newVal = val <= min ? 0 : val >= max ? 255 : ((val - min) / (max - min)) * 255;
                dst[i] = dst[i + 1] = dst[i + 2] = newVal;
                dst[i + 3] = 255;
            }
            
            ctx.putImageData(tempData, 0, 0);
            document.getElementById('frame').textContent = \`\${currentFrame + 1}/\${totalFrames}\`;
        }
        
        // ==================== UTILIDADES ====================
        function updateClock() {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString('es-CO');
        }
        
        function showMessage(text, type) {
            const msg = document.createElement('div');
            msg.className = \`message \${type}\`;
            msg.textContent = text;
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 300);
            }, 3500);
        }
    </script>
</body>
</html>
