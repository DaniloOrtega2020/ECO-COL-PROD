<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ECO-COL V1 - Parser Mejorado</title>
    <script src="https://unpkg.com/dicom-parser@1.8.11/dist/dicomParser.min.js"></script>
    <style>
        :root{--primary:#00695c;--accent:#00bfa5;--bg:#121212;--panel:#1e1e1e;--border:#333}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#fff;height:100vh;overflow:hidden}
        .header{background:linear-gradient(135deg,#004d40,var(--primary));padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--accent)}
        .header h1{font-size:1.5rem}
        .badge{background:var(--accent);color:#000;padding:0.25rem 0.75rem;border-radius:20px;font-size:0.75rem;font-weight:700}
        .main{display:grid;grid-template-columns:320px 1fr 360px;height:calc(100vh - 73px)}
        .panel{background:var(--panel);overflow-y:auto}
        .left{border-right:1px solid var(--border)}
        .right{border-left:1px solid var(--border);padding:1.5rem}
        .center{background:#000;display:flex;flex-direction:column;position:relative}
        .toolbar{background:#1a1a1a;padding:0.75rem;display:flex;gap:0.5rem;border-bottom:1px solid var(--border);flex-wrap:wrap}
        .btn{background:#2a2a2a;border:1px solid var(--border);color:#fff;padding:0.6rem 1rem;border-radius:6px;cursor:pointer;font-size:0.85rem;transition:all 0.3s}
        .btn:hover,.btn.active{background:var(--primary)}
        .viewer{flex:1;display:flex;align-items:center;justify-content:center;position:relative}
        #canvas{max-width:100%;max-height:100%;border:2px solid var(--accent);box-shadow:0 8px 32px rgba(0,191,165,0.3)}
        .overlay{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.9);padding:1rem;border-radius:8px;border:1px solid var(--accent);font-family:monospace;font-size:0.85rem;line-height:1.8;pointer-events:none}
        .overlay-label{color:var(--accent);font-weight:700;margin-right:0.5rem}
        .cine{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.95);padding:1rem 2rem;border-radius:50px;display:flex;gap:1.5rem;border:2px solid var(--accent)}
        .cine-btn{background:var(--primary);border:none;color:#fff;width:48px;height:48px;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:all 0.3s}
        .cine-btn:hover{background:var(--accent);transform:scale(1.1)}
        .frame-info{color:var(--accent);font-weight:700;min-width:100px;text-align:center}
        .study-card{background:#252525;border:1px solid var(--border);border-radius:8px;padding:1rem;margin:0.5rem;cursor:pointer;transition:all 0.3s}
        .study-card:hover,.study-card.active{background:linear-gradient(135deg,#1a4a44,#256d63);border-color:var(--accent)}
        .control-section{margin-bottom:2rem}
        .control-section h3{font-size:0.95rem;color:var(--accent);margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:2px solid var(--primary);text-transform:uppercase}
        .control-label{display:flex;justify-content:space-between;margin-bottom:0.5rem;font-size:0.85rem}
        .control-value{color:var(--accent);font-weight:700}
        input[type="range"]{width:100%;height:6px;background:var(--border);-webkit-appearance:none;border-radius:3px}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer}
        .stats{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
        .stat{background:#252525;padding:1rem;border-radius:8px;text-align:center;border:1px solid var(--border)}
        .stat-value{font-size:1.5rem;font-weight:700;color:var(--accent)}
        .stat-label{font-size:0.75rem;color:#b0b0b0;text-transform:uppercase}
        .pulse{width:10px;height:10px;border-radius:50%;background:#4caf50;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .search-box{width:100%;padding:0.75rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:#fff;font-size:0.9rem}
        .action-btn{padding:0.75rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s;text-transform:uppercase}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--accent);transform:translateY(-2px)}
        .btn-secondary{background:#2a2a2a;color:#fff;border:1px solid var(--border)}
        .drop-zone{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:3px dashed var(--accent);border-radius:12px;padding:3rem 2rem;text-align:center;color:var(--accent);font-size:1.2rem;pointer-events:none;opacity:0;transition:opacity 0.3s}
        .drop-zone.active{opacity:1}
        .message{position:fixed;top:90px;right:20px;padding:1rem 1.5rem;border-radius:8px;font-weight:600;z-index:9999;animation:slideIn 0.3s;box-shadow:0 8px 24px rgba(0,0,0,0.5)}
        .message.success{background:#388e3c;border:2px solid #66bb6a}
        .message.error{background:#d32f2f;border:2px solid #ef5350}
        @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex;align-items:center;gap:1rem">
            <h1>üè• ECO-COL V1</h1>
            <span class="badge">GRADO M√âDICO - PARSER MEJORADO</span>
        </div>
        <div style="display:flex;gap:2rem;align-items:center">
            <div style="display:flex;align-items:center;gap:0.5rem"><span class="pulse"></span>Sistema Activo</div>
            <div>üîí 100% Local</div>
            <div id="clock">--:--:--</div>
        </div>
    </div>
    <div class="main">
        <div class="panel left">
            <div style="padding:1.25rem;background:#252525;border-bottom:2px solid var(--primary)">
                <h2 style="font-size:1rem;color:var(--accent);margin-bottom:0.75rem;text-transform:uppercase">üìã ESTUDIOS DICOM</h2>
                <input type="text" class="search-box" placeholder="üîç Buscar..." oninput="searchStudies(this.value)">
                <button style="width:100%;margin-top:0.75rem;padding:0.75rem;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;text-transform:uppercase" onclick="uploadDICOM()">üì§ CARGAR DICOM/IMAGEN</button>
            </div>
            <div style="padding:0.5rem" id="studies-container"></div>
        </div>
        <div class="center" id="drop-area">
            <div class="toolbar">
                <button class="btn active" onclick="setTool('pan')">üîç Zoom/Pan</button>
                <button class="btn" onclick="setTool('window')">üéöÔ∏è Ventana</button>
                <button class="btn" onclick="invertColors()">üîÑ Invertir</button>
                <button class="btn" onclick="resetView()">‚Üª Reiniciar</button>
            </div>
            <div class="viewer">
                <canvas id="canvas" width="600" height="430"></canvas>
                <div class="overlay">
                    <div><span class="overlay-label">PACIENTE:</span><span id="patient">--</span></div>
                    <div><span class="overlay-label">ID:</span><span id="patid">--</span></div>
                    <div><span class="overlay-label">FECHA:</span><span id="date">--</span></div>
                    <div><span class="overlay-label">MODALIDAD:</span><span id="modality">--</span></div>
                    <div><span class="overlay-label">BITS:</span><span id="bits">--</span></div>
                    <div><span class="overlay-label">DIMENSIONES:</span><span id="dims">--</span></div>
                </div>
                <div class="cine">
                    <button class="cine-btn" id="play-btn" onclick="playPause()">‚ñ∂Ô∏è</button>
                    <button class="cine-btn" onclick="prev()">‚èÆÔ∏è</button>
                    <span class="frame-info" id="frame">Frame 1/1</span>
                    <button class="cine-btn" onclick="next()">‚è≠Ô∏è</button>
                    <button class="cine-btn" onclick="stop()">‚èπÔ∏è</button>
                </div>
                <div class="drop-zone" id="drop-zone">üìÅ Suelta archivos DICOM aqu√≠</div>
            </div>
        </div>
        <div class="panel right">
            <div class="control-section">
                <h3>üéöÔ∏è VENTANA / NIVEL</h3>
                <div style="margin-bottom:1.5rem">
                    <div class="control-label"><span>Centro</span><span class="control-value" id="cv">128</span></div>
                    <input type="range" id="center" min="0" max="255" value="128" oninput="updateWindow()">
                </div>
                <div>
                    <div class="control-label"><span>Ancho</span><span class="control-value" id="wv">255</span></div>
                    <input type="range" id="width" min="1" max="255" value="255" oninput="updateWindow()">
                </div>
            </div>
            <div class="control-section">
                <h3>üé¨ CONTROL DE CINE</h3>
                <div class="control-label"><span>FPS</span><span class="control-value" id="fv">10</span></div>
                <input type="range" id="fps" min="1" max="60" value="10" oninput="updateFPS()">
            </div>
            <div class="control-section">
                <h3>üîß HERRAMIENTAS</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                    <button class="action-btn btn-primary" onclick="exportImage()">üíæ Exportar</button>
                    <button class="action-btn btn-primary" onclick="printImage()">üñ®Ô∏è Imprimir</button>
                    <button class="action-btn btn-secondary" onclick="uploadDICOM()">üì§ Subir</button>
                    <button class="action-btn btn-secondary" onclick="showInfo()">‚ÑπÔ∏è Info</button>
                </div>
            </div>
            <div class="control-section">
                <h3>üìä ESTAD√çSTICAS</h3>
                <div class="stats">
                    <div class="stat"><div class="stat-value" id="st-studies">0</div><div class="stat-label">Estudios</div></div>
                    <div class="stat"><div class="stat-value" id="st-frames">0</div><div class="stat-label">Frames</div></div>
                    <div class="stat"><div class="stat-value" id="sf">10</div><div class="stat-label">FPS</div></div>
                    <div class="stat"><div class="stat-value" id="st-memory">0</div><div class="stat-label">MB</div></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let canvas,ctx,currentFrame=0,totalFrames=1,playing=false,interval,fps=10,currentTool='pan',loadedStudies=[],currentStudyIndex=-1;
        let allFrames=[],inverted=false;
        
        window.onload=function(){
            canvas=document.getElementById('canvas');
            ctx=canvas.getContext('2d');
            setupDragDrop();
            setInterval(()=>document.getElementById('clock').textContent=new Date().toLocaleTimeString('es-CO'),1000);
            console.log('üè• ECO-COL V1 - Parser Mejorado Activo');
        };
        
        function uploadDICOM(){
            const input=document.createElement('input');
            input.type='file';
            input.accept='.dcm,.dicom,image/*';
            input.multiple=true;
            input.onchange=e=>loadFiles(Array.from(e.target.files));
            input.click();
        }
        
        function loadFiles(files){
            files.forEach(file=>{
                const reader=new FileReader();
                if(file.name.match(/\.(dcm|dicom)$/i)){
                    reader.onload=e=>loadDICOMFile(e.target.result,file.name);
                    reader.readAsArrayBuffer(file);
                }else if(file.type.startsWith('image/')){
                    reader.onload=e=>loadImageFile(e.target.result,file.name);
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function loadImageFile(dataUrl,filename){
            const img=new Image();
            img.onload=function(){
                canvas.width=Math.min(img.width,1024);
                canvas.height=Math.min(img.height,1024);
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(img,0,0,canvas.width,canvas.height);
                const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
                allFrames=[imgData];
                addStudy({
                    type:'image',
                    filename,
                    patient:'IMAGEN',
                    patientId:'IMG-'+Date.now(),
                    date:new Date().toLocaleDateString('es-CO'),
                    modality:'IMG',
                    bits:8,
                    width:canvas.width,
                    height:canvas.height
                });
                showMessage(\`Imagen cargada: \${filename}\`,'success');
            };
            img.src=dataUrl;
        }
        
        function loadDICOMFile(arrayBuffer,filename){
            try{
                const dataSet=dicomParser.parseDicom(new Uint8Array(arrayBuffer));
                
                // Extraer metadata
                const patientName=dataSet.string('x00100010')||'PACIENTE DICOM';
                const patientID=dataSet.string('x00100020')||'ID-'+Date.now();
                const studyDate=dataSet.string('x00080020')||new Date().toISOString().slice(0,10).replace(/-/g,'');
                const modality=dataSet.string('x00080060')||'US';
                
                // Dimensiones y profundidad
                const rows=dataSet.uint16('x00280010');
                const cols=dataSet.uint16('x00280011');
                const bitsAllocated=dataSet.uint16('x00280100')||8;
                const samplesPerPixel=dataSet.uint16('x00280002')||1;
                const photometric=dataSet.string('x00280004')||'MONOCHROME2';
                
                // N√∫mero de frames
                const numFrames=dataSet.string('x00280008')?parseInt(dataSet.string('x00280008')):1;
                
                // Pixel data
                const pixelDataElement=dataSet.elements.x7fe00010;
                if(!pixelDataElement)throw new Error('No pixel data found');
                
                const pixelData=new Uint8Array(dataSet.byteArray.buffer,pixelDataElement.dataOffset,pixelDataElement.length);
                
                canvas.width=cols;
                canvas.height=rows;
                
                console.log('üìä DICOM Info:',{rows,cols,bitsAllocated,samplesPerPixel,photometric,numFrames,dataSize:pixelData.length});
                
                allFrames=[];
                const pixelsPerFrame=rows*cols;
                const bytesPerPixel=bitsAllocated===16?2:1;
                
                // Procesar cada frame
                for(let f=0;f<numFrames;f++){
                    const imgData=ctx.createImageData(cols,rows);
                    const data=imgData.data;
                    const frameOffset=f*pixelsPerFrame*bytesPerPixel;
                    
                    if(samplesPerPixel===3){
                        // Color RGB
                        for(let i=0;i<pixelsPerFrame;i++){
                            const idx=frameOffset+i*3;
                            data[i*4]=pixelData[idx];
                            data[i*4+1]=pixelData[idx+1];
                            data[i*4+2]=pixelData[idx+2];
                            data[i*4+3]=255;
                        }
                    }else if(bitsAllocated===8){
                        // 8-bit grayscale
                        for(let i=0;i<pixelsPerFrame;i++){
                            const val=pixelData[frameOffset+i];
                            data[i*4]=data[i*4+1]=data[i*4+2]=val;
                            data[i*4+3]=255;
                        }
                    }else if(bitsAllocated===16){
                        // 16-bit grayscale
                        for(let i=0;i<pixelsPerFrame;i++){
                            const idx=frameOffset+i*2;
                            const val16=(pixelData[idx+1]<<8)|pixelData[idx];
                            const val8=Math.floor((val16/65535)*255);
                            data[i*4]=data[i*4+1]=data[i*4+2]=val8;
                            data[i*4+3]=255;
                        }
                    }
                    
                    allFrames.push(imgData);
                }
                
                currentFrame=0;
                totalFrames=numFrames;
                
                ctx.putImageData(allFrames[0],0,0);
                
                addStudy({
                    type:'dicom',
                    filename,
                    patient:patientName,
                    patientId:patientID,
                    date:studyDate,
                    modality,
                    bits:bitsAllocated,
                    width:cols,
                    height:rows,
                    frames:numFrames
                });
                
                showMessage(\`DICOM cargado: \${numFrames} frames\`,'success');
            }catch(error){
                console.error('‚ùå Error:',error);
                showMessage('Error: '+error.message,'error');
            }
        }
        
        function setupDragDrop(){
            const dropArea=document.getElementById('drop-area');
            const dropZone=document.getElementById('drop-zone');
            ['dragenter','dragover','dragleave','drop'].forEach(e=>{
                dropArea.addEventListener(e,ev=>{ev.preventDefault();ev.stopPropagation()},false);
            });
            ['dragenter','dragover'].forEach(e=>dropArea.addEventListener(e,()=>dropZone.classList.add('active'),false));
            ['dragleave','drop'].forEach(e=>dropArea.addEventListener(e,()=>dropZone.classList.remove('active'),false));
            dropArea.addEventListener('drop',e=>loadFiles(Array.from(e.dataTransfer.files)),false);
        }
        
        function addStudy(study){
            loadedStudies.push(study);
            currentStudyIndex=loadedStudies.length-1;
            updateStudiesList();
            updateOverlay(study);
            updateStats();
        }
        
        function render(){
            if(allFrames.length===0)return;
            const imgData=allFrames[currentFrame];
            
            // Aplicar windowing
            const tempData=ctx.createImageData(canvas.width,canvas.height);
            const src=imgData.data;
            const dst=tempData.data;
            const center=parseFloat(document.getElementById('center').value);
            const width=parseFloat(document.getElementById('width').value);
            const min=center-width/2;
            const max=center+width/2;
            
            for(let i=0;i<src.length;i+=4){
                let val=src[i];
                if(inverted)val=255-val;
                let newVal=val<=min?0:val>=max?255:((val-min)/(max-min))*255;
                dst[i]=dst[i+1]=dst[i+2]=newVal;
                dst[i+3]=255;
            }
            
            ctx.putImageData(tempData,0,0);
            document.getElementById('frame').textContent=\`Frame \${currentFrame+1}/\${totalFrames}\`;
        }
        
        function playPause(){
            if(totalFrames<=1)return;
            playing=!playing;
            const btn=document.getElementById('play-btn');
            if(playing){
                interval=setInterval(()=>{
                    currentFrame=(currentFrame+1)%totalFrames;
                    render();
                },1000/fps);
                btn.textContent='‚è∏Ô∏è';
            }else{
                clearInterval(interval);
                btn.textContent='‚ñ∂Ô∏è';
            }
        }
        
        function next(){if(allFrames.length>0){currentFrame=(currentFrame+1)%totalFrames;render()}}
        function prev(){if(allFrames.length>0){currentFrame=(currentFrame-1+totalFrames)%totalFrames;render()}}
        function stop(){playing=false;clearInterval(interval);currentFrame=0;render();document.getElementById('play-btn').textContent='‚ñ∂Ô∏è'}
        
        function updateWindow(){
            document.getElementById('cv').textContent=document.getElementById('center').value;
            document.getElementById('wv').textContent=document.getElementById('width').value;
            render();
        }
        
        function updateFPS(){
            fps=parseInt(document.getElementById('fps').value);
            document.getElementById('fv').textContent=fps;
            document.getElementById('sf').textContent=fps;
        }
        
        function resetView(){
            document.getElementById('center').value=128;
            document.getElementById('width').value=255;
            inverted=false;
            updateWindow();
        }
        
        function invertColors(){
            inverted=!inverted;
            render();
        }
        
        function setTool(tool){
            currentTool=tool;
            document.querySelectorAll('.toolbar .btn').forEach(b=>b.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function loadStudy(index){
            if(index<0||index>=loadedStudies.length)return;
            currentStudyIndex=index;
            const study=loadedStudies[index];
            currentFrame=0;
            render();
            updateOverlay(study);
            document.querySelectorAll('.study-card').forEach(c=>c.classList.remove('active'));
            document.querySelector(\`[data-index="\${index}"]\`).classList.add('active');
        }
        
        function updateStudiesList(){
            const container=document.getElementById('studies-container');
            container.innerHTML='';
            loadedStudies.forEach((study,index)=>{
                const card=document.createElement('div');
                card.className='study-card'+(index===currentStudyIndex?' active':'');
                card.setAttribute('data-index',index);
                card.onclick=()=>loadStudy(index);
                card.innerHTML=\`
                    <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
                        <span style="font-weight:700;color:var(--accent);font-size:0.9rem">\${study.filename||'ESTUDIO #'+(index+1)}</span>
                        <span style="background:var(--primary);padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:700">\${study.modality}</span>
                    </div>
                    <div style="font-size:0.85rem;color:#b0b0b0;line-height:1.6">
                        <div><strong style="color:#fff">Paciente:</strong> \${study.patient}</div>
                        <div><strong style="color:#fff">ID:</strong> \${study.patientId}</div>
                        <div><strong style="color:#fff">Fecha:</strong> \${study.date}</div>
                        <div><strong style="color:#fff">Frames:</strong> \${study.frames||1}</div>
                    </div>
                \`;
                container.appendChild(card);
            });
        }
        
        function updateOverlay(study){
            document.getElementById('patient').textContent=study.patient;
            document.getElementById('patid').textContent=study.patientId;
            document.getElementById('date').textContent=study.date;
            document.getElementById('modality').textContent=study.modality;
            document.getElementById('bits').textContent=study.bits+'bits';
            document.getElementById('dims').textContent=\`\${study.width}x\${study.height}\`;
        }
        
        function updateStats(){
            document.getElementById('st-studies').textContent=loadedStudies.length;
            document.getElementById('st-frames').textContent=totalFrames;
            let totalBytes=allFrames.reduce((sum,f)=>sum+f.data.length,0);
            document.getElementById('st-memory').textContent=Math.round(totalBytes/1024/1024);
        }
        
        function searchStudies(query){
            document.querySelectorAll('.study-card').forEach(card=>{
                card.style.display=card.textContent.toLowerCase().includes(query.toLowerCase())?'block':'none';
            });
        }
        
        function exportImage(){
            const url=canvas.toDataURL('image/png');
            const a=document.createElement('a');
            a.download=\`eco-col-frame-\${currentFrame+1}.png\`;
            a.href=url;
            a.click();
            showMessage('Imagen exportada','success');
        }
        
        function printImage(){window.print()}
        
        function showInfo(){
            const study=loadedStudies[currentStudyIndex];
            if(!study)return;
            alert(\`üìä INFORMACI√ìN DEL ESTUDIO

Paciente: \${study.patient}
ID: \${study.patientId}
Fecha: \${study.date}
Modalidad: \${study.modality}
Dimensiones: \${study.width}x\${study.height}
Profundidad: \${study.bits} bits
Frames: \${study.frames||1}
Archivo: \${study.filename}\`);
        }
        
        function showMessage(text,type){
            const msg=document.createElement('div');
            msg.className=\`message \${type}\`;
            msg.textContent=text;
            document.body.appendChild(msg);
            setTimeout(()=>{msg.style.opacity='0';setTimeout(()=>msg.remove(),300)},3000);
        }
    </script>
</body>
</html>
