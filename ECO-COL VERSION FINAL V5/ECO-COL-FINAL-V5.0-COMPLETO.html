<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECO-COL FINAL V5.0 - Sistema Completo Hospital 1 ‚Üî Hospital 2</title>
    
    <!-- Cornerstone DICOM Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cornerstone-tools@6.0.10/dist/cornerstoneTools.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dicom-parser@1.8.13/dist/dicomParser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --accent: #00bfa5;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #252525;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #333;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), #1e88e5);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            max-width: 1800px;
            margin: 1rem auto 0;
            padding: 0 2rem;
        }
        
        .tab {
            padding: 0.8rem 1.5rem;
            background: var(--bg-medium);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab:hover { background: var(--bg-light); }
        .tab.active { background: var(--bg-dark); color: var(--accent); }
        
        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Section */
        .section {
            background: var(--bg-medium);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            color: var(--accent);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 6px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* Button */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,191,165,0.2);
            border-color: var(--accent);
        }
        
        .card h3 {
            color: var(--accent);
            margin-bottom: 0.8rem;
        }
        
        .card p {
            color: var(--text-secondary);
            margin: 0.3rem 0;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 0.5rem;
            margin-right: 0.5rem;
        }
        
        .status-badge.pending {
            background: var(--warning);
            color: #000;
        }
        
        .status-badge.completed {
            background: var(--success);
            color: #fff;
        }
        
        .status-badge.has-dicom {
            background: var(--primary);
            color: #fff;
        }
        
        /* Viewer */
        .viewer-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            height: 80vh;
        }
        
        .viewer-main {
            background: #000;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .viewer-toolbar {
            background: rgba(0,0,0,0.9);
            padding: 0.8rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
        }
        
        .viewer-viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .viewer-sidebar {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-y: auto;
        }
        
        .info-group {
            margin-bottom: 1.5rem;
        }
        
        .info-group h3 {
            color: var(--accent);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .slider-control {
            margin-bottom: 1rem;
        }
        
        .slider-control label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .slider {
            width: 100%;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 10000;
            animation: slideIn 0.3s;
            font-weight: 600;
        }
        
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }
        .notification.info { background: var(--primary); }
        .notification.warning { background: var(--warning); color: #000; }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        
        .loading-content {
            text-align: center;
            color: var(--accent);
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Input file hidden */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>üè• ECO-COL FINAL V5.0 <span class="badge">SISTEMA COMPLETO</span></h1>
            <div style="display: flex; gap: 2rem; font-size: 0.9rem;">
                <div>üìç Popay√É¬°n, Colombia</div>
                <div>üîí 100% Local + IndexedDB</div>
                <div id="system-status">üü¢ Sistema Activo</div>
            </div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('hospital1')">üè• Hospital #1 (Perif√©rico)</button>
        <button class="tab" onclick="switchTab('hospital2')">üë®‚Äç‚öïÔ∏è Hospital #2 (Radi√≥logos)</button>
        <button class="tab" onclick="switchTab('admin')">‚öôÔ∏è Administrador</button>
    </div>
    
    <div class="container">
        <!-- ==================== HOSPITAL 1 TAB ==================== -->
        <div id="tab-hospital1" class="tab-content active">
            <!-- Registro de Paciente -->
            <div class="section">
                <h2>‚ûï Registrar Nuevo Paciente</h2>
                <form id="patient-form">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="patient-name" required>
                        </div>
                        <div class="form-group">
                            <label>DNI / C√©dula *</label>
                            <input type="text" id="patient-dni" required>
                        </div>
                        <div class="form-group">
                            <label>Edad</label>
                            <input type="number" id="patient-age">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label>G√©nero</label>
                            <select id="patient-gender">
                                <option value="M">Masculino</option>
                                <option value="F">Femenino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tel√©fono</label>
                            <input type="tel" id="patient-phone">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Registrar Paciente</button>
                </form>
            </div>
            
            <!-- Crear Estudio -->
            <div class="section">
                <h2>üìã Crear Estudio y Cargar Ecograf√≠a</h2>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label>Seleccionar Paciente *</label>
                            <select id="h1-patient-select">
                                <option value="">-- Seleccione un paciente --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Hospital de Origen</label>
                            <input type="text" id="h1-hospital" value="Hospital Regional Norte - Popay√°n" readonly>
                        </div>
                        <div class="form-group">
                            <label>Modalidad</label>
                            <select id="h1-modality">
                                <option value="US">US - Ultrasonido</option>
                                <option value="CT">CT - Tomograf√≠a</option>
                                <option value="MR">MR - Resonancia</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="uploadDICOMH1()">üì§ Cargar Archivo DICOM</button>
                        <input type="file" id="h1-dicom-file" accept=".dcm,.dicom" onchange="handleDICOMUploadH1(event)">
                        <div id="h1-upload-status" style="margin-top: 1rem; color: var(--text-secondary);"></div>
                    </div>
                    <div id="h1-preview" style="background: #000; border-radius: 8px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        Vista previa
                    </div>
                </div>
                <button class="btn btn-success" style="width: 100%; margin-top: 1rem;" onclick="sendToHospital2()" id="h1-send-btn" disabled>
                    üöÄ ENVIAR AL HOSPITAL #2
                </button>
            </div>
            
            <!-- Lista de Estudios -->
            <div class="section">
                <h2>üìã Mis Estudios</h2>
                <div class="grid" id="h1-studies-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No hay estudios registrados</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== HOSPITAL 2 TAB ==================== -->
        <div id="tab-hospital2" class="tab-content">
            <!-- Login Radi√≥logos -->
            <div id="h2-login-section" class="section">
                <h2>üë®‚Äç‚öïÔ∏è Seleccionar Radi√≥logo</h2>
                <div class="grid">
                    <div class="card" onclick="loginRadiologist('Dr. Danilo Ortega')">
                        <h3>Dr. Danilo Ortega</h3>
                        <p><strong>Especialidad:</strong> Radiolog√≠a Abdominal</p>
                        <p><strong>Pendientes:</strong> <span id="ortega-pending">0</span></p>
                        <span class="status-badge has-dicom">RADI√ìLOGO</span>
                    </div>
                    <div class="card" onclick="loginRadiologist('Dra. Mar√≠a Mart√≠nez')">
                        <h3>Dra. Mar√≠a Mart√≠nez</h3>
                        <p><strong>Especialidad:</strong> Ecograf√≠a Obst√©trica</p>
                        <p><strong>Pendientes:</strong> <span id="martinez-pending">0</span></p>
                        <span class="status-badge has-dicom">RADI√ìLOGA</span>
                    </div>
                    <div class="card" onclick="loginRadiologist('Dr. Carlos Rodr√≠guez')">
                        <h3>Dr. Carlos Rodr√≠guez</h3>
                        <p><strong>Especialidad:</strong> Ecograf√≠a Card√≠aca</p>
                        <p><strong>Pendientes:</strong> <span id="rodriguez-pending">0</span></p>
                        <span class="status-badge has-dicom">RADI√ìLOGO</span>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Trabajo -->
            <div id="h2-worklist-section" style="display: none;">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>üìã Lista de Trabajo</h2>
                        <button class="btn btn-danger" onclick="logoutRadiologist()">üö™ Cerrar Sesi√≥n</button>
                    </div>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Radi√≥logo: <strong id="currentUser" style="color: var(--accent);">-</strong>
                    </p>
                    <div class="grid" id="h2-studies-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No hay estudios pendientes</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visor DICOM -->
            <div id="h2-viewer-section" style="display: none;">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>üñºÔ∏è Visor DICOM</h2>
                        <button class="btn btn-primary" onclick="backToWorklistH2()">‚Üê Volver a Lista</button>
                    </div>
                    
                    <div class="viewer-container">
                        <div class="viewer-main">
                            <div class="viewer-toolbar">
                                <button class="btn btn-primary" onclick="setToolH2('Wwwc')">üé® Ventana</button>
                                <button class="btn btn-primary" onclick="setToolH2('Zoom')">üîç Zoom</button>
                                <button class="btn btn-primary" onclick="setToolH2('Pan')">‚úã Pan</button>
                                <button class="btn btn-primary" onclick="setToolH2('Length')">üìè Medir</button>
                                <button class="btn btn-primary" onclick="resetViewH2()">‚Üª Reset</button>
                            </div>
                            <div class="viewer-viewport">
                                <div id="h2-viewport" style="width: 512px; height: 512px; background: #000;"></div>
                            </div>
                        </div>
                        
                        <div class="viewer-sidebar">
                            <div class="info-group">
                                <h3>üë§ Informaci√≥n del Paciente</h3>
                                <p><strong>Nombre:</strong> <span id="h2-patient-name">-</span></p>
                                <p><strong>DNI:</strong> <span id="h2-patient-dni">-</span></p>
                                <p><strong>Edad:</strong> <span id="h2-patient-age">-</span></p>
                                <p><strong>Estudio:</strong> <span id="h2-study-id">-</span></p>
                            </div>
                            
                            <div class="info-group">
                                <h3>üé® Controles</h3>
                                <div class="slider-control">
                                    <label>
                                        <span>Window Center</span>
                                        <span id="h2-wc-value">-</span>
                                    </label>
                                    <input type="range" class="slider" id="h2-window-center" min="-1000" max="4000" value="40" oninput="updateWindowH2()">
                                </div>
                                <div class="slider-control">
                                    <label>
                                        <span>Window Width</span>
                                        <span id="h2-ww-value">-</span>
                                    </label>
                                    <input type="range" class="slider" id="h2-window-width" min="1" max="4000" value="400" oninput="updateWindowH2()">
                                </div>
                            </div>
                            
                            <div class="info-group">
                                <h3>üìù Observaciones</h3>
                                <textarea id="h2-observations" rows="6" placeholder="Escribir hallazgos y diagn√≥stico..." style="width: 100%; padding: 0.8rem; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; border-radius: 6px;"></textarea>
                                <button class="btn btn-primary" style="width: 100%; margin-top: 0.5rem;" onclick="saveObservationsH2()">üíæ Guardar</button>
                                <button class="btn btn-success" style="width: 100%; margin-top: 0.5rem;" onclick="completeStudyH2()">‚úÖ Completar y Enviar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== ADMIN TAB ==================== -->
        <div id="tab-admin" class="tab-content">
            <div class="section">
                <h2>üìä Estad√≠sticas del Sistema</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Estudios</div>
                        <div class="stat-value" id="admin-total-studies">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pendientes</div>
                        <div class="stat-value" id="admin-pending-studies" style="color: var(--warning);">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Completados</div>
                        <div class="stat-value" id="admin-completed-studies" style="color: var(--success);">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Pacientes</div>
                        <div class="stat-value" id="admin-total-patients">0</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>üìã Todos los Estudios</h2>
                <div class="grid" id="admin-studies-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loading-text">Procesando...</div>
        </div>
    </div>
    
    <script>
        // ==================== CORNERSTONE INITIALIZATION ====================
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
        cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
        cornerstoneTools.external.cornerstone = cornerstone;
        cornerstoneTools.external.Hammer = Hammer;
        cornerstoneTools.external.cornerstoneMath = cornerstoneMath;
        
        cornerstoneTools.init();
        cornerstoneTools.addTool(cornerstoneTools.WwwcTool);
        cornerstoneTools.addTool(cornerstoneTools.ZoomTool);
        cornerstoneTools.addTool(cornerstoneTools.PanTool);
        cornerstoneTools.addTool(cornerstoneTools.LengthTool);

        // ==================== INDEXEDDB DATABASE MANAGER ====================
        class DatabaseManager {
            constructor() {
                this.db = null;
                this.cache = new Map();
            }
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('ECO-COL-FINAL-V5', 1);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        
                        if (!db.objectStoreNames.contains('patients')) {
                            db.createObjectStore('patients', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('studies')) {
                            db.createObjectStore('studies', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('dicom_files')) {
                            db.createObjectStore('dicom_files', { keyPath: 'studyId' });
                        }
                        
                        console.log('‚úÖ IndexedDB schema created');
                    };
                    
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        console.log('‚úÖ IndexedDB initialized');
                        resolve();
                    };
                    
                    request.onerror = () => {
                        console.error('‚ùå IndexedDB error:', request.error);
                        reject(request.error);
                    };
                });
            }
            
            // Patients
            async addPatient(patient) {
                patient.id = 'PAC-' + String(Date.now()).slice(-8);
                patient.createdAt = new Date().toISOString();
                
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['patients'], 'readwrite');
                    const store = tx.objectStore('patients');
                    const request = store.add(patient);
                    
                    request.onsuccess = () => {
                        console.log(`‚úÖ Patient added: ${patient.id}`);
                        resolve(patient);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getAllPatients() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['patients'], 'readonly');
                    const store = tx.objectStore('patients');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getPatient(id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['patients'], 'readonly');
                    const store = tx.objectStore('patients');
                    const request = store.get(id);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            // Studies
            async addStudy(study) {
                study.id = 'ECO-' + String(Date.now()).slice(-8);
                study.status = 'pending';
                study.createdAt = new Date().toISOString();
                study.radiologist = null;
                study.observations = '';
                study.completedAt = null;
                
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['studies'], 'readwrite');
                    const store = tx.objectStore('studies');
                    const request = store.add(study);
                    
                    request.onsuccess = () => {
                        console.log(`‚úÖ Study added: ${study.id}`);
                        resolve(study);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }
            
            async updateStudy(id, updates) {
                const study = await this.getStudy(id);
                if (!study) throw new Error(`Study ${id} not found`);
                
                Object.assign(study, updates);
                
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['studies'], 'readwrite');
                    const store = tx.objectStore('studies');
                    const request = store.put(study);
                    
                    request.onsuccess = () => {
                        console.log(`‚úÖ Study updated: ${id}`);
                        resolve(study);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getStudy(id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['studies'], 'readonly');
                    const store = tx.objectStore('studies');
                    const request = store.get(id);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getAllStudies() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['studies'], 'readonly');
                    const store = tx.objectStore('studies');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            // DICOM Files
            async saveDICOMFile(studyId, fileBlob, metadata) {
                const arrayBuffer = await fileBlob.arrayBuffer();
                
                const data = {
                    studyId,
                    dicomData: arrayBuffer,
                    metadata: {
                        ...metadata,
                        uploadedAt: new Date().toISOString(),
                        size: arrayBuffer.byteLength
                    }
                };
                
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['dicom_files'], 'readwrite');
                    const store = tx.objectStore('dicom_files');
                    const request = store.put(data);
                    
                    request.onsuccess = () => {
                        console.log(`‚úÖ DICOM saved: ${studyId} (${(arrayBuffer.byteLength / 1024).toFixed(2)} KB)`);
                        this.cache.set('dicom_' + studyId, data);
                        resolve(data);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getDICOMFile(studyId) {
                if (this.cache.has('dicom_' + studyId)) {
                    console.log(`‚ö° Cache hit: ${studyId}`);
                    return this.cache.get('dicom_' + studyId);
                }
                
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['dicom_files'], 'readonly');
                    const store = tx.objectStore('dicom_files');
                    const request = store.get(studyId);
                    
                    request.onsuccess = () => {
                        const data = request.result;
                        if (data) {
                            console.log(`‚úÖ DICOM loaded: ${studyId}`);
                            this.cache.set('dicom_' + studyId, data);
                        }
                        resolve(data);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }
        }

        const DB = new DatabaseManager();
        
        // Global Variables
        let currentRadiologist = null;
        let currentH2Study = null;
        let h2Element = null;
        let h2ImageIds = [];
        let h2CurrentIndex = 0;
        let h1CurrentStudyId = null;

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading('Inicializando sistema...');
                await DB.init();
                hideLoading();
                notify('‚úÖ Sistema ECO-COL FINAL V5.0 listo', 'success');
                console.log('‚úÖ System initialized');
            } catch (error) {
                hideLoading();
                notify('‚ùå Error al inicializar: ' + error.message, 'error');
                console.error('‚ùå Init error:', error);
            }
        });

        // ==================== HOSPITAL 1 FUNCTIONS ====================
        
        // Patient Form
        document.getElementById('patient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const patient = {
                    name: document.getElementById('patient-name').value,
                    dni: document.getElementById('patient-dni').value,
                    age: document.getElementById('patient-age').value,
                    gender: document.getElementById('patient-gender').value,
                    phone: document.getElementById('patient-phone').value
                };
                
                await DB.addPatient(patient);
                notify('‚úÖ Paciente registrado correctamente', 'success');
                e.target.reset();
                await loadH1Patients();
            } catch (error) {
                notify('‚ùå Error: ' + error.message, 'error');
            }
        });

        async function loadH1Patients() {
            const select = document.getElementById('h1-patient-select');
            const patients = await DB.getAllPatients();
            
            select.innerHTML = '<option value="">-- Seleccione un paciente --</option>';
            patients.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.name} (${p.dni})`;
                select.appendChild(option);
            });
        }

        function uploadDICOMH1() {
            const patientId = document.getElementById('h1-patient-select').value;
            if (!patientId) {
                notify('‚ö†Ô∏è Seleccione un paciente primero', 'warning');
                return;
            }
            document.getElementById('h1-dicom-file').click();
        }

        async function handleDICOMUploadH1(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showLoading('Procesando DICOM...');
                
                // Register file
                const baseImageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(file);
                
                // Load metadata
                const image = await cornerstone.loadImage(baseImageId);
                const numFrames = parseInt(image.data.string('x00280008') || '1');
                
                console.log(`‚úÖ DICOM loaded: ${numFrames} frames`);
                
                // Create study
                const patientId = document.getElementById('h1-patient-select').value;
                const study = {
                    patientId,
                    hospital: document.getElementById('h1-hospital').value,
                    modality: document.getElementById('h1-modality').value,
                    date: new Date().toISOString().split('T')[0],
                    hasDICOM: true
                };
                
                const newStudy = await DB.addStudy(study);
                h1CurrentStudyId = newStudy.id;
                
                // Save DICOM file
                await DB.saveDICOMFile(newStudy.id, file, {
                    filename: file.name,
                    numFrames,
                    baseImageId
                });
                
                document.getElementById('h1-upload-status').innerHTML = `
                    <strong style="color: var(--success);">‚úÖ DICOM cargado correctamente</strong><br>
                    Archivo: ${file.name}<br>
                    Frames: ${numFrames}<br>
                    Tama√±o: ${(file.size / 1024).toFixed(2)} KB
                `;
                
                document.getElementById('h1-send-btn').disabled = false;
                
                hideLoading();
                notify('‚úÖ DICOM procesado correctamente', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå DICOM upload error:', error);
                notify('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function sendToHospital2() {
            if (!h1CurrentStudyId) {
                notify('‚ö†Ô∏è No hay estudio para enviar', 'warning');
                return;
            }
            
            try {
                showLoading('Enviando al Hospital #2...');
                
                await DB.updateStudy(h1CurrentStudyId, {
                    status: 'pending'
                });
                
                notify('‚úÖ Estudio enviado al Hospital #2', 'success');
                
                // Reset form
                document.getElementById('h1-patient-select').value = '';
                document.getElementById('h1-upload-status').innerHTML = '';
                document.getElementById('h1-send-btn').disabled = true;
                h1CurrentStudyId = null;
                
                await loadH1Studies();
                hideLoading();
                
            } catch (error) {
                hideLoading();
                notify('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function loadH1Studies() {
            const list = document.getElementById('h1-studies-list');
            const studies = await DB.getAllStudies();
            
            if (studies.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No hay estudios registrados</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            for (const study of studies) {
                const patient = await DB.getPatient(study.patientId);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${study.id}</h3>
                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'N/A'}</p>
                    <p><strong>Hospital:</strong> ${study.hospital}</p>
                    <p><strong>Fecha:</strong> ${study.date}</p>
                    <span class="status-badge ${study.status}">${study.status === 'pending' ? 'PENDIENTE' : 'COMPLETADO'}</span>
                    ${study.hasDICOM ? '<span class="status-badge has-dicom">‚úÖ DICOM</span>' : ''}
                    ${study.observations ? `<p style="margin-top: 1rem; padding: 0.8rem; background: rgba(0,191,165,0.1); border-radius: 6px;"><strong>Observaciones:</strong><br>${study.observations}</p>` : ''}
                `;
                list.appendChild(card);
            }
        }

        // ==================== HOSPITAL 2 FUNCTIONS ====================
        
        function loginRadiologist(name) {
            currentRadiologist = name;
            document.getElementById('currentUser').textContent = name;
            document.getElementById('h2-login-section').style.display = 'none';
            document.getElementById('h2-worklist-section').style.display = 'block';
            loadH2Worklist();
            notify(`‚úÖ Bienvenido ${name}`, 'success');
        }

        function logoutRadiologist() {
            currentRadiologist = null;
            document.getElementById('h2-login-section').style.display = 'block';
            document.getElementById('h2-worklist-section').style.display = 'none';
            document.getElementById('h2-viewer-section').style.display = 'none';
        }

        async function loadH2Worklist() {
            const list = document.getElementById('h2-studies-list');
            const studies = await DB.getAllStudies();
            const pendingStudies = studies.filter(s => s.status === 'pending' && s.hasDICOM);
            
            // Update counters
            document.getElementById('ortega-pending').textContent = pendingStudies.length;
            document.getElementById('martinez-pending').textContent = pendingStudies.length;
            document.getElementById('rodriguez-pending').textContent = pendingStudies.length;
            
            if (pendingStudies.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No hay estudios pendientes</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            for (const study of pendingStudies) {
                const patient = await DB.getPatient(study.patientId);
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openStudyH2(study.id);
                card.innerHTML = `
                    <h3>${study.id}</h3>
                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'N/A'}</p>
                    <p><strong>DNI:</strong> ${patient ? patient.dni : 'N/A'}</p>
                    <p><strong>Hospital:</strong> ${study.hospital}</p>
                    <p><strong>Fecha:</strong> ${study.date}</p>
                    <span class="status-badge pending">PENDIENTE</span>
                    <span class="status-badge has-dicom">‚úÖ DICOM</span>
                `;
                list.appendChild(card);
            }
        }

        async function openStudyH2(studyId) {
            try {
                showLoading('Cargando estudio...');
                
                currentH2Study = await DB.getStudy(studyId);
                const patient = await DB.getPatient(currentH2Study.patientId);
                
                // Show viewer
                document.getElementById('h2-worklist-section').style.display = 'none';
                document.getElementById('h2-viewer-section').style.display = 'block';
                
                // Update patient info
                document.getElementById('h2-patient-name').textContent = patient ? patient.name : '-';
                document.getElementById('h2-patient-dni').textContent = patient ? patient.dni : '-';
                document.getElementById('h2-patient-age').textContent = patient ? patient.age : '-';
                document.getElementById('h2-study-id').textContent = currentH2Study.id;
                document.getElementById('h2-observations').value = currentH2Study.observations || '';
                
                // ‚úÖ CRITICAL: Load DICOM from IndexedDB
                const dicomData = await DB.getDICOMFile(studyId);
                
                if (!dicomData) {
                    throw new Error('DICOM no encontrado');
                }
                
                // Reconstruct File
                const blob = new Blob([dicomData.dicomData], { type: 'application/dicom' });
                const file = new File([blob], dicomData.metadata.filename, { 
                    type: 'application/dicom' 
                });
                
                // Register in Cornerstone
                const baseImageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(file);
                
                // Load metadata
                const image = await cornerstone.loadImage(baseImageId);
                const numFrames = parseInt(image.data.string('x00280008') || '1');
                
                // Generate imageIds with CORRECT format
                h2ImageIds = [];
                for (let i = 0; i < numFrames; i++) {
                    h2ImageIds.push(`${baseImageId}&frame=${i}`);  // ‚úÖ Using & not ?
                }
                
                console.log(`‚úÖ Loaded ${h2ImageIds.length} frames`);
                
                // Initialize viewport
                h2Element = document.getElementById('h2-viewport');
                cornerstone.enable(h2Element);
                
                // Load first frame
                h2CurrentIndex = 0;
                await loadImageH2(h2ImageIds[0]);
                
                // Setup tools
                cornerstoneTools.addStackStateManager(h2Element, ['stack']);
                cornerstoneTools.addToolState(h2Element, 'stack', {
                    imageIds: h2ImageIds,
                    currentImageIdIndex: 0
                });
                
                hideLoading();
                notify(`‚úÖ Estudio cargado (${h2ImageIds.length} frames)`, 'success');
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå Open study error:', error);
                notify('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function loadImageH2(imageId) {
            const image = await cornerstone.loadImage(imageId);
            cornerstone.displayImage(h2Element, image);
        }

        function backToWorklistH2() {
            document.getElementById('h2-worklist-section').style.display = 'block';
            document.getElementById('h2-viewer-section').style.display = 'none';
            currentH2Study = null;
            h2ImageIds = [];
        }

        function setToolH2(toolName) {
            if (!h2Element) return;
            
            cornerstoneTools.setToolActive(toolName, { mouseButtonMask: 1 });
        }

        function resetViewH2() {
            if (!h2Element) return;
            cornerstone.reset(h2Element);
        }

        function updateWindowH2() {
            if (!h2Element) return;
            
            const viewport = cornerstone.getViewport(h2Element);
            viewport.voi.windowCenter = parseFloat(document.getElementById('h2-window-center').value);
            viewport.voi.windowWidth = parseFloat(document.getElementById('h2-window-width').value);
            cornerstone.setViewport(h2Element, viewport);
            
            document.getElementById('h2-wc-value').textContent = viewport.voi.windowCenter.toFixed(0);
            document.getElementById('h2-ww-value').textContent = viewport.voi.windowWidth.toFixed(0);
        }

        async function saveObservationsH2() {
            if (!currentH2Study) return;
            
            try {
                const observations = document.getElementById('h2-observations').value;
                await DB.updateStudy(currentH2Study.id, {
                    observations,
                    radiologist: currentRadiologist
                });
                notify('‚úÖ Observaciones guardadas', 'success');
            } catch (error) {
                notify('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function completeStudyH2() {
            if (!currentH2Study) return;
            
            const observations = document.getElementById('h2-observations').value;
            if (!observations.trim()) {
                notify('‚ö†Ô∏è Agregue observaciones primero', 'warning');
                return;
            }
            
            if (!confirm('¬øCompletar estudio y enviar al Hospital #1?')) return;
            
            try {
                showLoading('Completando estudio...');
                
                await DB.updateStudy(currentH2Study.id, {
                    status: 'completed',
                    observations,
                    radiologist: currentRadiologist,
                    completedAt: new Date().toISOString()
                });
                
                notify('‚úÖ Estudio completado y enviado al Hospital #1', 'success');
                
                backToWorklistH2();
                await loadH2Worklist();
                hideLoading();
                
            } catch (error) {
                hideLoading();
                notify('‚ùå Error: ' + error.message, 'error');
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        
        async function loadAdminData() {
            const studies = await DB.getAllStudies();
            const patients = await DB.getAllPatients();
            
            document.getElementById('admin-total-studies').textContent = studies.length;
            document.getElementById('admin-pending-studies').textContent = studies.filter(s => s.status === 'pending').length;
            document.getElementById('admin-completed-studies').textContent = studies.filter(s => s.status === 'completed').length;
            document.getElementById('admin-total-patients').textContent = patients.length;
            
            const list = document.getElementById('admin-studies-list');
            list.innerHTML = '';
            
            for (const study of studies) {
                const patient = await DB.getPatient(study.patientId);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${study.id}</h3>
                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'N/A'}</p>
                    <p><strong>Hospital:</strong> ${study.hospital}</p>
                    <p><strong>Fecha:</strong> ${study.date}</p>
                    <p><strong>Radi√≥logo:</strong> ${study.radiologist || 'Pendiente'}</p>
                    <span class="status-badge ${study.status}">${study.status.toUpperCase()}</span>
                `;
                list.appendChild(card);
            }
        }

        // ==================== TAB SWITCHING ====================
        
        async function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'hospital1') {
                await loadH1Patients();
                await loadH1Studies();
            } else if (tabName === 'admin') {
                await loadAdminData();
            }
        }

        // ==================== UTILITIES ====================
        
        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        function notify(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
    </script>
</body>
</html>
